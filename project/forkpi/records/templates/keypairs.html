{% extends 'base.html' %}

{% block content%}

<ul id="tabs" class="nav nav-pills nav-justified" data-tabs="tabs">
    <li><a href="#new-keypair" data-toggle="tab">Add New Keypair</a></li>
    <li class="active"><a href="#edit-keypairs" data-toggle="tab">View and Edit Keypairs</a></li>
</ul>


<div class="tab-content">
	<div class="tab-pane" id="new-keypair">
		<br/><br/>
		<div class="col-md-10 col-md-offset-1">
			<form class="form-horizontal" accept-charset="UTF-8" method="post" action="{% url 'add keypair' %}">
				<div class="form-group">
					<label for="name" class="col-md-2 control-label">Name</label>
					<div class="col-md-10">
						<input type="text" class="form-control"
							   id="newName" name="name"
							   placeholder="John Smith" />
					</div>
				</div>
				<div class="form-group">
					<label for="doors" class="col-md-2 control-label">Doors</label>
					<div class="col-md-10" data-search-url="{% url 'search doors' %}">
						<input type="text" class="form-control"
							   id="newDoors" name="doors" />
					</div>
				</div>

				<div class="form-group">
					<label for="pin" class="col-md-2 control-label">PIN</label>
					<div class="col-md-10">
						<input type="text" class="form-control"
							   id="newPin" name="pin" 
							   placeholder="Enter numeric PIN of any length"/>
					</div>
				</div>
				<div class="form-group">
					<label for="rfid_uid" class="col-md-2 control-label">RFID UID</label>
					<div class="col-md-8">
						<input type="text" class="form-control"
							   id="newRfid" name="rfid_uid"
							   placeholder="Scan for an RFID tag or paste the UID here" />
					</div>
					<div class="col-md-2" data-scan-url="{% url 'scan rfid' %}"
						 data-field="rfid" data-target-textbox="#newRfid">
						<input type="button" class="btn expand btn-success scan-new"
							   value="Scan RFID" />
					</div>
				</div>
				<div class="form-group">
					<label for="fingerprint_template" class="col-md-2 control-label">Fingerprint</label>
					<div class="col-md-8">
						<input type="text" class="form-control"
							   id="newFinger" name="fingerprint_template"
							   placeholder="Scan for a finger or paste the template here" />
					</div>
					<div class="col-md-2" data-scan-url="{% url 'scan fingerprint' %}"
						 data-field="fingerprint" data-target-textbox="#newFinger">
						<input type="button" class="btn expand btn-success scan-new"
							   value="Scan Finger"/>
					</div>
				</div>

				<div class="form-group">
					<div class="col-md-10 col-md-offset-2">
						<button class="btn expand btn-primary signup-button" type="submit">
							Add to Keypairs
						</button>
					</div>
				</div>
				{% csrf_token %}
			</form>
		</div>
	</div>
	<div class="tab-pane active" id="edit-keypairs">
		<div class="col-md-12">
			<table id="keypairs-table" class="table table-hover tablesorter tablesaw"
					data-tablesaw-minimap data-tablesaw-mode="columntoggle" data-sortList="[[0,0]]">
				<thead>
					<tr>
						<th class="col-md-1" data-placeholder="Search..." data-tablesaw-priority="-1">
							#
						</th>
						<th class="col-md-4" data-placeholder="Search..." data-tablesaw-priority="persist">
							Name
						</th>
						<th class="col-md-6" data-placeholder="Search..." data-tablesaw-priority="2">
							Doors
						</th>
						<th class="col-md-4" data-placeholder="Search..." data-tablesaw-priority="3">
							PIN
						</th>
						<th class="col-md-5" data-placeholder="Search..." data-tablesaw-priority="4">
							RFID UID
						</th>
						<th class="col-md-5" data-placeholder="Search..." data-tablesaw-priority="5">
							Fingerprint
						</th>
						<th class="col-md-4" data-placeholder="Search..." data-tablesaw-priority="7">
							Actions
						</th>
						<!-- <th class="col-md-3" data-placeholder="Search..." data-tablesaw-priority="10">
							Last Edited By
						</th> -->
					</tr>
				</thead>
				<tbody>
					{% for keypair in keypairs %}
					<tr class="
						{% if not keypair.is_active %}
							greyed
						{% endif %}
					">
						<td>{{ forloop.counter }}</td>

						<!-- Name -->
						<td data-post-url="{% url 'edit keypair name' %}"
							data-field="name"
							data-id="{{ keypair.id }}" data-value="{{ keypair.name }}">

							<span class="editable-text">
								{{ keypair.name }}
							</span>
						</td>

						<!-- Doors -->
						<td data-search-url="{% url 'search doors' %}"
							data-link-url="{% url 'link door to keypair' %}"
							data-unlink-url="{% url 'unlink door from keypair' %}"
							data-field="doors"
							data-id="{{ keypair.id }}" data-value="{{ keypair.doors_json }}">
							
							<span class="editable-text">
								{% if keypair.doors_json %}
									{% for door in keypair.doors_json %}
									<li class="token-input-token-facebook">
										{{ door.name }}
									</li>
									{% endfor %}
								{% else %}
									- - -
								{% endif %}
							</span>
						</td>

						<!-- PIN -->
						<td data-post-url="{% url 'edit keypair pin' %}"
							data-field="pin"
							data-id="{{ keypair.id }}" data-value="{{ keypair.pin }}">

							<span class="editable-text">
								{% if keypair.pin %}
									{{ keypair.pin }}
								{% else %}
									- - -
								{% endif %}
							</span>
						</td>

						<!-- RFID UID -->
						<td data-post-url="{% url 'edit keypair rfid' %}" data-scan-url="{% url 'scan rfid' %}"
							data-field="rfid" data-target-textbox=".editing-text"
							data-id="{{ keypair.id }}" data-value="{{ keypair.rfid_uid }}">

							<span class="editable-text">
								{% if keypair.rfid_uid %}
									{{ keypair.rfid_uid }}
								{% else %}
									- - -
								{% endif %}
							</span>
						</td>

						<!-- Fingerprint -->
						<td data-post-url="{% url 'edit keypair fingerprint' %}" data-scan-url="{% url 'scan fingerprint' %}"
							data-field="fingerprint" data-target-textbox=".editing-text"
							data-id="{{ keypair.id }}" data-value="{{ keypair.fingerprint_template }}">

							<span class="editable-text">
								{% if keypair.fingerprint_template %}
									{{ keypair.fingerprint_template }}
								{% else %}
									- - -
								{% endif %}
							</span>
						</td>
						
						<!-- Actions -->
						<td id="action-{{ keypair.id }}">
							<div class="btn-group btn-group-justified" role="group">
								<div class="btn-group" role="group"
									 data-post-url="{% url 'keypair toggle active' %}"
									 data-id="{{ keypair.id }}">

									{% if keypair.is_active %}
										<button class="btn expand btn-warning task-cancelbox deactivate-btn">
											Deactivate
										</button>
									{% else %}
										<button class="btn expand btn-success task-cancelbox activate-btn">
											Activate
										</button>
									{% endif %}
								</div>
								<div class="btn-group" role="group"
									 data-post-url="{% url 'delete keypair' %}"
									 data-id="{{ keypair.id }}">

									<button class="btn btn-danger task-cancelbox delete-btn">
										Delete
									</button>
								</div>
							</div>
						</td>

						<!-- <td>
							<div>
								{{ keypair.last_edited_by.username }}
							</div>
							<div class="small-text">
								{{ keypair.last_edited_on | date:"Y-m-d H:i"}}
							</div>
						</td> -->
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
		<button class="btn btn-primary col-md-2 col-md-offset-5"
		        onclick="window.location='{% url 'print pdf' %}'">Download as PDF</button>
	</div>
</div>

{% endblock %}